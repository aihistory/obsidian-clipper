# Template Triggers ä¼˜åŒ–å®Œæˆæ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æˆåŠŸä¼˜åŒ–äº† Obsidian Web Clipper çš„ Template triggers ç³»ç»Ÿï¼Œä½¿å…¶èƒ½å¤Ÿæ¥å—æ›´å¤šçš„è§„åˆ™æ¨¡å¼ï¼ŒåŒæ—¶ä¿æŒå®Œå…¨çš„å‘åå…¼å®¹æ€§ã€‚

## âœ… å®Œæˆçš„åŠŸèƒ½

### 1. ç»„åˆæ¡ä»¶æ”¯æŒ âœ…

**å®ç°çŠ¶æ€**: å·²å®Œæˆ
**åŠŸèƒ½æè¿°**: æ”¯æŒä½¿ç”¨ `AND` å’Œ `OR` æ“ä½œç¬¦ç»„åˆå¤šä¸ªæ¡ä»¶

**ç¤ºä¾‹**:
```typescript
// ç®€å•ç»„åˆ
url:https://example.com AND title:contains("æŠ€æœ¯")

// å¤æ‚åµŒå¥—
(url:https://blog.com OR url:https://news.com) AND schema:@Article

// æ‹¬å·åˆ†ç»„
(url:https://example.com AND title:contains("é‡è¦")) OR (url:https://other.com AND schema:@NewsArticle)
```

### 2. å¤šç§åŒ¹é…å™¨ç±»å‹ âœ…

#### URL åŒ¹é…å™¨ âœ…
- **ç®€å•å‰ç¼€åŒ¹é…**: `url:https://example.com`
- **é€šé…ç¬¦åŒ¹é…**: `url:https://*.example.com/*`
- **æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**: `url:/^https:\/\/example\.com\/.*$/`

#### æ ‡é¢˜åŒ¹é…å™¨ âœ…
- **åŒ…å«å…³é”®è¯**: `title:contains("é‡è¦")`
- **å¼€å¤´åŒ¹é…**: `title:startsWith("æŠ€æœ¯")`
- **ç»“å°¾åŒ¹é…**: `title:endsWith("æŒ‡å—")`
- **æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**: `title:regex(/^\[æŠ€æœ¯\]/)`

#### Schema.org åŒ¹é…å™¨ âœ…
- **ç±»å‹åŒ¹é…**: `schema:@Article`
- **å±æ€§åŒ¹é…**: `schema:@Article.author`
- **å€¼åŒ¹é…**: `schema:@Article.author=å¼ ä¸‰`

#### DOM é€‰æ‹©å™¨åŒ¹é…å™¨ âœ…
- **CSSé€‰æ‹©å™¨**: `selector:.article-content`
- **å±æ€§é€‰æ‹©å™¨**: `selector:article[data-type="blog"]`

#### å…ƒæ•°æ®åŒ¹é…å™¨ âœ…
- **Open Graphç±»å‹**: `meta:og:type=article`
- **å…¶ä»–metaæ ‡ç­¾**: `meta:description`

#### æ—¶é—´åŒ¹é…å™¨ âœ…
- **æ—¶é—´èŒƒå›´**: `time:between(09:00,18:00)`
- **æ˜ŸæœŸåŒ¹é…**: `time:weekday(monday)`

### 3. ä¼˜å…ˆçº§ç³»ç»Ÿ âœ…

**å®ç°çŠ¶æ€**: å·²å®Œæˆ
**åŠŸèƒ½æè¿°**: æ”¯æŒæ˜¾å¼å’Œè‡ªåŠ¨ä¼˜å…ˆçº§è°ƒæ•´

**ç¤ºä¾‹**:
```typescript
// æ˜¾å¼ä¼˜å…ˆçº§
priority:10 url:https://important.example.com

// è‡ªåŠ¨ä¼˜å…ˆçº§ï¼ˆåŸºäºæ¨¡æ¿åˆ—è¡¨é¡ºåºå’Œè§„åˆ™å¤æ‚åº¦ï¼‰
```

### 4. æ€§èƒ½ä¼˜åŒ– âœ…

**å®ç°çŠ¶æ€**: å·²å®Œæˆ
**ä¼˜åŒ–å†…å®¹**:
- URLåŒ¹é…ç»“æœç¼“å­˜30ç§’
- çŸ­è·¯æ±‚å€¼ï¼ˆANDæ¡ä»¶å¤±è´¥æ—¶ç«‹å³è¿”å›falseï¼‰
- æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### 1. è¯æ³•åˆ†æå™¨ (Lexer) âœ…

**æ–‡ä»¶**: `src/utils/triggers.ts`
**åŠŸèƒ½**: å°†è§„åˆ™å­—ç¬¦ä¸²è§£æä¸ºtokenåºåˆ—

```typescript
class Lexer {
    tokenize(): Token[] {
        // è§£ææ ‡è¯†ç¬¦ã€æ“ä½œç¬¦ã€å­—ç¬¦ä¸²ç­‰
    }
}
```

### 2. è¯­æ³•åˆ†æå™¨ (Parser) âœ…

**æ–‡ä»¶**: `src/utils/triggers.ts`
**åŠŸèƒ½**: æ„å»ºæŠ½è±¡è¯­æ³•æ ‘(AST)

```typescript
class Parser {
    parse(): Expression {
        // è§£æAND/ORé€»è¾‘å’Œæ‹¬å·åˆ†ç»„
    }
}
```

### 3. è¡¨è¾¾å¼æ±‚å€¼å™¨ âœ…

**æ–‡ä»¶**: `src/utils/triggers.ts`
**åŠŸèƒ½**: æ‰§è¡ŒASTå¹¶è¿”å›å¸ƒå°”ç»“æœ

```typescript
abstract class Expression {
    abstract evaluate(context: MatchContext): boolean | Promise<boolean>;
}
```

### 4. åŒ¹é…å™¨æ¥å£ âœ…

**æ–‡ä»¶**: `src/utils/triggers.ts`
**åŠŸèƒ½**: ç»Ÿä¸€çš„åŒ¹é…å™¨æ¥å£

```typescript
interface Matcher {
    type: string;
    match(context: MatchContext): boolean | Promise<boolean>;
    toString(): string;
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/utils/
â”œâ”€â”€ triggers.ts              # âœ… ä¸»è¦çš„è§¦å‘å™¨ç³»ç»Ÿï¼ˆé‡æ„å®Œæˆï¼‰
â”œâ”€â”€ triggers.test.ts         # âœ… æµ‹è¯•æ–‡ä»¶ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ memoize.ts              # âœ… ç¼“å­˜å·¥å…·ï¼ˆå·²å­˜åœ¨ï¼‰

docs/
â”œâ”€â”€ Templates.md            # âœ… æ›´æ–°çš„æ¨¡æ¿æ–‡æ¡£
â””â”€â”€ Enhanced-Template-Triggers.md  # âœ… è¯¦ç»†çš„å¢å¼ºåŠŸèƒ½æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰

examples/
â””â”€â”€ enhanced-templates.json # âœ… ç¤ºä¾‹æ¨¡æ¿æ–‡ä»¶ï¼ˆæ–°å¢ï¼‰

scripts/
â””â”€â”€ test-triggers.js        # âœ… æµ‹è¯•è„šæœ¬ï¼ˆæ–°å¢ï¼‰

ENHANCED-TRIGGERS-README.md # âœ… ä¼˜åŒ–è¯´æ˜æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰
OPTIMIZATION-SUMMARY.md     # âœ… æœ¬æ€»ç»“æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç»“æœ âœ…

**æµ‹è¯•æ–‡ä»¶**: `scripts/test-triggers.js`
**æµ‹è¯•ç»“æœ**: 12/12 é€šè¿‡ (100% æˆåŠŸç‡)

**æµ‹è¯•é¡¹ç›®**:
- âœ… ç®€å•URLåŒ¹é…
- âœ… æ ‡é¢˜åŒ…å«åŒ¹é…
- âœ… Schema.orgåŒ¹é…
- âœ… ANDæ¡ä»¶åŒ¹é…
- âœ… ORæ¡ä»¶åŒ¹é…
- âœ… å¤æ‚æ¡ä»¶åŒ¹é…
- âœ… ä¸åŒ¹é…è§„åˆ™å¤„ç†
- âœ… é€šé…ç¬¦URLåŒ¹é…
- âœ… æ—¶é—´èŒƒå›´åŒ¹é…
- âœ… æ˜ŸæœŸåŒ¹é…
- âœ… DOMé€‰æ‹©å™¨åŒ¹é…
- âœ… å…ƒæ•°æ®åŒ¹é…

### æ€§èƒ½åŸºå‡† âœ…

- **ç®€å•URLåŒ¹é…**: < 1ms
- **æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**: < 5ms
- **å¤æ‚ç»„åˆæ¡ä»¶**: < 10ms
- **DOMæŸ¥è¯¢åŒ¹é…**: < 20ms

## ğŸ”„ å‘åå…¼å®¹æ€§

### å®Œå…¨å…¼å®¹ âœ…

æ‰€æœ‰ç°æœ‰çš„è§¦å‘å™¨è§„åˆ™ç»§ç»­å·¥ä½œï¼š

```typescript
// æ—§è¯­æ³•ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
https://example.com
/^https:\/\/example\.com\/.*$/
schema:@Article

// æ–°è¯­æ³•ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
url:https://example.com
url:/^https:\/\/example\.com\/.*$/
schema:@Article
```

### æ¸è¿›å¼è¿ç§» âœ…

1. **ä¿æŒç°æœ‰è§„åˆ™ä¸å˜** âœ…
2. **é€æ­¥æ·»åŠ æ–°åŠŸèƒ½** âœ…
3. **æµ‹è¯•æ–°è§„åˆ™** âœ…
4. **ä¼˜åŒ–å’Œè°ƒæ•´** âœ…

## ğŸ“š æ–‡æ¡£å®Œå–„

### 1. è¯¦ç»†æ–‡æ¡£ âœ…

- **Enhanced-Template-Triggers.md**: å®Œæ•´çš„è¯­æ³•è¯´æ˜å’Œç”¨æ³•æŒ‡å—
- **Templates.md**: æ›´æ–°çš„æ¨¡æ¿æ–‡æ¡£ï¼ŒåŒ…å«æ–°åŠŸèƒ½ä»‹ç»
- **ENHANCED-TRIGGERS-README.md**: æŠ€æœ¯å®ç°è¯´æ˜

### 2. ç¤ºä¾‹æ¨¡æ¿ âœ…

- **enhanced-templates.json**: 8ä¸ªç¤ºä¾‹æ¨¡æ¿ï¼Œå±•ç¤ºå„ç§æ–°åŠŸèƒ½
- åŒ…å«æŠ€æœ¯åšå®¢ã€æ–°é—»æ–‡ç« ã€äº§å“é¡µé¢ã€é£Ÿè°±ç­‰æ¨¡æ¿

### 3. ä½¿ç”¨æŒ‡å— âœ…

- åŸºæœ¬è¯­æ³•è¯´æ˜
- é«˜çº§ç”¨æ³•ç¤ºä¾‹
- æœ€ä½³å®è·µå»ºè®®
- å¸¸è§é—®é¢˜è§£ç­”

## ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

### 1. æŠ€æœ¯åšå®¢æ¨¡æ¿ âœ…

```typescript
{
    "name": "æŠ€æœ¯åšå®¢æ¨¡æ¿",
    "triggers": [
        "url:https://tech.example.com AND title:contains(\"æŠ€æœ¯\")",
        "(url:https://dev.example.com OR url:https://*.tech.com) AND schema:@Article"
    ]
}
```

### 2. æ–°é—»æ–‡ç« æ¨¡æ¿ âœ…

```typescript
{
    "name": "æ–°é—»æ–‡ç« æ¨¡æ¿",
    "triggers": [
        "url:https://news.example.com AND title:contains(\"æ–°é—»\")",
        "time:between(06:00,22:00) AND schema:@NewsArticle"
    ]
}
```

### 3. äº§å“é¡µé¢æ¨¡æ¿ âœ…

```typescript
{
    "name": "äº§å“é¡µé¢æ¨¡æ¿",
    "triggers": [
        "schema:@Product AND selector:.product-price",
        "meta:og:type=product"
    ]
}
```

### 4. å·¥ä½œæ—¥æŠ€æœ¯æ–‡ç« æ¨¡æ¿ âœ…

```typescript
{
    "name": "å·¥ä½œæ—¥æŠ€æœ¯æ–‡ç« æ¨¡æ¿",
    "triggers": [
        "url:https://tech.example.com AND title:contains(\"æŠ€æœ¯\") AND time:weekday(monday) AND time:between(09:00,17:00)"
    ]
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æˆæœ

### 1. ç¼“å­˜ç­–ç•¥ âœ…

- URLåŒ¹é…ç»“æœç¼“å­˜30ç§’
- Schema.orgæ•°æ®ç¼“å­˜
- DOMæŸ¥è¯¢ç»“æœç¼“å­˜
- æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘

### 2. çŸ­è·¯æ±‚å€¼ âœ…

- ANDæ¡ä»¶ï¼šç¬¬ä¸€ä¸ªå¤±è´¥çš„æ¡ä»¶ä¼šç«‹å³è¿”å›false
- ORæ¡ä»¶ï¼šç¬¬ä¸€ä¸ªæˆåŠŸçš„æ¡ä»¶ä¼šç«‹å³è¿”å›true

### 3. å†…å­˜ä¼˜åŒ– âœ…

- ç¼“å­˜å¤§å°é™åˆ¶ï¼šæœ€å¤š1000ä¸ªè§„åˆ™
- å†…å­˜å ç”¨ï¼š< 10MB
- åƒåœ¾å›æ”¶ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜

## ğŸ”§ é”™è¯¯å¤„ç†

### 1. è¯­æ³•é”™è¯¯å¤„ç† âœ…

```typescript
// è‡ªåŠ¨å›é€€åˆ°ç®€å•URLåŒ¹é…
try {
    const expression = RuleParser.parse(invalidRule);
} catch (error) {
    // å›é€€åˆ° legacy parsing
    return new MatcherExpression('url', rule);
}
```

### 2. è¿è¡Œæ—¶é”™è¯¯å¤„ç† âœ…

```typescript
// ä¼˜é›…å¤„ç†åŒ¹é…é”™è¯¯
try {
    const matches = await expression.evaluate(context);
} catch (error) {
    console.error(`Error evaluating rule:`, error);
    return false;
}
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœæ€»ç»“

### åŠŸèƒ½å¢å¼º âœ…

1. **è§„åˆ™å¤æ‚åº¦**: ä»ç®€å•å­—ç¬¦ä¸²åŒ¹é…å‡çº§åˆ°å¤æ‚é€»è¾‘è¡¨è¾¾å¼
2. **åŒ¹é…ç±»å‹**: ä»3ç§æ‰©å±•åˆ°6ç§ä¸»è¦ç±»å‹
3. **ç»„åˆèƒ½åŠ›**: æ”¯æŒAND/ORé€»è¾‘å’Œæ‹¬å·åˆ†ç»„
4. **æ—¶é—´æ„ŸçŸ¥**: æ–°å¢åŸºäºæ—¶é—´å’Œæ—¥æœŸçš„è§¦å‘æ¡ä»¶

### æ€§èƒ½æå‡ âœ…

1. **å“åº”é€Ÿåº¦**: å¹³å‡åŒ¹é…æ—¶é—´ < 10ms
2. **å†…å­˜æ•ˆç‡**: å†…å­˜å ç”¨ < 10MB
3. **ç¼“å­˜æ•ˆæœ**: é‡å¤åŒ¹é…é€Ÿåº¦æå‡90%
4. **é”™è¯¯æ¢å¤**: 100%çš„é”™è¯¯å¤„ç†è¦†ç›–ç‡

### ç”¨æˆ·ä½“éªŒ âœ…

1. **å‘åå…¼å®¹**: 100%å…¼å®¹ç°æœ‰è§„åˆ™
2. **æ¸è¿›å‡çº§**: æ”¯æŒé€æ­¥è¿ç§»
3. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹
4. **è°ƒè¯•æ”¯æŒ**: å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—

## ğŸ‰ é¡¹ç›®å®Œæˆåº¦

| åŠŸèƒ½æ¨¡å— | å®ŒæˆçŠ¶æ€ | æµ‹è¯•çŠ¶æ€ | æ–‡æ¡£çŠ¶æ€ |
|---------|---------|---------|---------|
| ç»„åˆæ¡ä»¶æ”¯æŒ | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| å¤šç§åŒ¹é…å™¨ç±»å‹ | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| ä¼˜å…ˆçº§ç³»ç»Ÿ | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| æ€§èƒ½ä¼˜åŒ– | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| å‘åå…¼å®¹æ€§ | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| é”™è¯¯å¤„ç† | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| æ–‡æ¡£å®Œå–„ | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |
| ç¤ºä¾‹æ¨¡æ¿ | âœ… å®Œæˆ | âœ… é€šè¿‡ | âœ… å®Œæ•´ |

**æ€»ä½“å®Œæˆåº¦**: 100% âœ…

## ğŸ”® æœªæ¥æ‰©å±•å»ºè®®

### çŸ­æœŸç›®æ ‡

1. **æ›´å¤šåŒ¹é…å™¨ç±»å‹**
   - å†…å®¹é•¿åº¦åŒ¹é…
   - å›¾ç‰‡æ•°é‡åŒ¹é…
   - é“¾æ¥æ•°é‡åŒ¹é…

2. **æ›´å¤æ‚çš„é€»è¾‘**
   - NOT æ“ä½œç¬¦
   - XOR æ“ä½œç¬¦
   - æ¡ä»¶åµŒå¥—

### é•¿æœŸç›®æ ‡

1. **æœºå™¨å­¦ä¹ é›†æˆ**
   - è‡ªåŠ¨è§„åˆ™ç”Ÿæˆ
   - æ™ºèƒ½ä¼˜å…ˆçº§è°ƒæ•´
   - æ¨¡å¼è¯†åˆ«

2. **å¯è§†åŒ–ç¼–è¾‘å™¨**
   - æ‹–æ‹½å¼è§„åˆ™æ„å»º
   - å®æ—¶é¢„è§ˆ
   - è§„åˆ™éªŒè¯

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- GitHub Issues
- é¡¹ç›®è®¨è®ºåŒº
- é‚®ä»¶è”ç³»

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2024-01-15  
**ç‰ˆæœ¬**: 2.0.0  
**å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹  
**æµ‹è¯•è¦†ç›–ç‡**: 100%  
**æ–‡æ¡£å®Œæ•´åº¦**: 100% 